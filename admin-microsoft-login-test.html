<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Admin Microsoft Login - New Flow</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin: 0;
        font-size: 2.5em;
        font-weight: 300;
      }

      .content {
        padding: 40px;
      }

      .test-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
      }

      .test-section h3 {
        color: #495057;
        margin-top: 0;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }

      .btn {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
      }

      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745, #1e7e34);
      }

      .test-result {
        padding: 20px;
        border-radius: 8px;
        margin: 15px 0;
        white-space: pre-wrap;
        font-family: "Courier New", monospace;
        font-size: 14px;
        line-height: 1.6;
      }

      .test-result.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .test-result.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .test-result.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }

      .api-endpoint {
        background: #343a40;
        color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-family: "Courier New", monospace;
        margin: 10px 0;
      }

      .flow-step {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #007bff;
      }

      .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .input-group {
        margin: 15px 0;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .input-group input,
      .input-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 16px;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 10px;
      }

      .status-badge.success {
        background: #d4edda;
        color: #155724;
      }

      .status-badge.error {
        background: #f8d7da;
        color: #721c24;
      }

      .status-badge.pending {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîê Admin Microsoft Login Test</h1>
        <p>
          Test lu·ªìng ƒëƒÉng nh·∫≠p Microsoft m·ªõi cho Admin (kh√¥ng qua URL callback)
        </p>
      </div>

      <div class="content">
        <!-- Flow Documentation -->
        <div class="test-section">
          <h3>üìã Lu·ªìng ƒêƒÉng Nh·∫≠p Microsoft M·ªõi</h3>
          <div class="flow-step">
            <strong>B∆∞·ªõc 1:</strong> G·ªçi
            <code>POST /api/admin/auth/login</code> v·ªõi
            <code>provider: "microsoft"</code>
          </div>
          <div class="flow-step">
            <strong>B∆∞·ªõc 2:</strong> Backend tr·∫£ v·ªÅ authorization code ho·∫∑c
            token trong response.data
          </div>
          <div class="flow-step">
            <strong>B∆∞·ªõc 3a:</strong> N·∫øu c√≥ token ‚Üí L∆∞u token v√† l·∫•y profile
          </div>
          <div class="flow-step">
            <strong>B∆∞·ªõc 3b:</strong> N·∫øu c√≥ code ‚Üí G·ªçi
            <code>POST /api/admin/auth/callback</code> ƒë·ªÉ exchange
          </div>
          <div class="flow-step">
            <strong>B∆∞·ªõc 4:</strong> G·ªçi
            <code>GET /api/admin/get-profile</code> v√† redirect dashboard
          </div>
        </div>

        <!-- API Configuration -->
        <div class="test-section">
          <h3>‚öôÔ∏è API Configuration</h3>
          <div class="input-group">
            <label for="apiBase">API Base URL:</label>
            <input
              type="text"
              id="apiBase"
              value="https://giasuvlu.click/api"
            />
          </div>
          <div class="input-group">
            <label for="provider">Provider Type:</label>
            <select id="provider">
              <option value="microsoft">microsoft</option>
              <option value="Microsoft">Microsoft</option>
              <option value="MICROSOFT">MICROSOFT</option>
            </select>
          </div>
        </div>

        <!-- Current Status -->
        <div class="test-section">
          <h3>üìä Current Status</h3>
          <div id="status-display">
            <div>
              Authentication Token:
              <span id="token-status" class="status-badge error"
                >Not Found</span
              >
            </div>
            <div>
              Admin Role:
              <span id="role-status" class="status-badge error">Not Set</span>
            </div>
            <div>
              Admin Profile:
              <span id="profile-status" class="status-badge error"
                >Not Loaded</span
              >
            </div>
          </div>
          <button class="btn btn-success" onclick="checkCurrentStatus()">
            üîÑ Refresh Status
          </button>
          <button class="btn btn-danger" onclick="clearAuthData()">
            üóëÔ∏è Clear Auth Data
          </button>
        </div>

        <!-- Test Microsoft Login -->
        <div class="test-section">
          <h3>üß™ Test Microsoft Login Flow</h3>
          <p>Ki·ªÉm tra lu·ªìng ƒëƒÉng nh·∫≠p Microsoft m·ªõi v·ªõi backend API.</p>

          <button class="btn" onclick="testMicrosoftLogin()">
            üöÄ Test Microsoft Login
          </button>

          <div id="login-results" class="test-result info">
            Click n√∫t tr√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu test...
          </div>
        </div>

        <!-- Manual API Testing -->
        <div class="test-section">
          <h3>üîß Manual API Testing</h3>
          <p>Test c√°c endpoint ri√™ng l·∫ª ƒë·ªÉ debug.</p>

          <button class="btn" onclick="testLoginEndpoint()">
            Test Login Endpoint
          </button>
          <button class="btn" onclick="testCallbackEndpoint()">
            Test Callback Endpoint
          </button>
          <button class="btn" onclick="testProfileEndpoint()">
            Test Profile Endpoint
          </button>

          <div class="input-group">
            <label for="authCode"
              >Authorization Code (for callback test):</label
            >
            <input
              type="text"
              id="authCode"
              placeholder="Enter authorization code here..."
            />
          </div>

          <div id="manual-results" class="test-result info">
            Manual test results s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...
          </div>
        </div>

        <!-- Expected Responses -->
        <div class="test-section">
          <h3>üìù Expected API Responses</h3>
          <h4>POST /admin/auth/login Response:</h4>
          <div class="api-endpoint">
            { "success": true, "message": "Microsoft auth successful", "data": {
            "token": "eyJhbGciOiJIUzI1NiIs...", // Ho·∫∑c "code":
            "M.R3_BAY.CdG_Uy...", // authorization code "authorizationCode":
            "M.R3_BAY.CdG_Uy..." // alternative field name } }
          </div>

          <h4>POST /admin/auth/callback Response:</h4>
          <div class="api-endpoint">
            { "success": true, "message": "Token exchange successful", "data": {
            "token": "eyJhbGciOiJIUzI1NiIs...", "adminProfile": { ... } //
            optional } }
          </div>

          <h4>GET /admin/get-profile Response:</h4>
          <div class="api-endpoint">
            { "success": true, "message": "Profile fetched successfully",
            "data": { "adminId": "ADMIN001", "fullname": "Admin User", "email":
            "admin@giasuvlu.click", "role": "admin" } }
          </div>
        </div>
      </div>
    </div>

    <script>
      // Utility functions
      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        console.log(`[${timestamp}] ${message}`);
      }

      function setResult(elementId, content, isSuccess = false) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = content;
          element.className = `test-result ${isSuccess ? "success" : "error"}`;
        }
      }

      function getApiBase() {
        return document.getElementById("apiBase").value.trim();
      }

      function getProvider() {
        return document.getElementById("provider").value;
      }

      // Status checking functions
      function checkCurrentStatus() {
        log("Checking current authentication status...");

        // Check cookies
        const token = getCookie("token");
        const role = getCookie("role");

        // Update status display
        const tokenStatus = document.getElementById("token-status");
        const roleStatus = document.getElementById("role-status");
        const profileStatus = document.getElementById("profile-status");

        if (token) {
          tokenStatus.textContent = "Found";
          tokenStatus.className = "status-badge success";
        } else {
          tokenStatus.textContent = "Not Found";
          tokenStatus.className = "status-badge error";
        }

        if (role === "admin") {
          roleStatus.textContent = "Admin";
          roleStatus.className = "status-badge success";
        } else if (role) {
          roleStatus.textContent = role;
          roleStatus.className = "status-badge error";
        } else {
          roleStatus.textContent = "Not Set";
          roleStatus.className = "status-badge error";
        }

        // Check if we have profile data (this would need to be stored somewhere)
        const hasProfile = token && role === "admin";
        if (hasProfile) {
          profileStatus.textContent = "Available";
          profileStatus.className = "status-badge success";
        } else {
          profileStatus.textContent = "Not Loaded";
          profileStatus.className = "status-badge error";
        }

        log("Status check completed");
      }

      function clearAuthData() {
        log("Clearing all authentication data...");

        // Clear cookies
        document.cookie = "token=; path=/; max-age=0";
        document.cookie = "role=; path=/; max-age=0";

        // Clear localStorage (if any)
        localStorage.removeItem("token");
        localStorage.removeItem("role");
        localStorage.removeItem("adminProfile");

        checkCurrentStatus();
        log("Authentication data cleared");
      }

      function getCookie(name) {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          const [key, value] = cookie.trim().split("=");
          if (key === name) return value;
        }
        return null;
      }

      // Main test function
      async function testMicrosoftLogin() {
        const resultsDiv = document.getElementById("login-results");
        resultsDiv.textContent = "üîÑ Testing Microsoft Login Flow...\n";
        resultsDiv.className = "test-result info";

        try {
          const apiBase = getApiBase();
          const provider = getProvider();

          log(`Starting Microsoft login test with provider: ${provider}`);

          // Step 1: Call admin/auth/login
          resultsDiv.textContent += `\nüì° Step 1: Calling POST ${apiBase}/admin/auth/login\n`;
          resultsDiv.textContent += `Provider: ${provider}\n`;

          const loginResponse = await fetch(`${apiBase}/admin/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              provider: provider,
            }),
          });

          const loginData = await loginResponse.json();
          resultsDiv.textContent += `\nüì• Login Response (${loginResponse.status}):\n`;
          resultsDiv.textContent += JSON.stringify(loginData, null, 2) + "\n";

          if (!loginResponse.ok) {
            throw new Error(
              `Login API failed: ${loginResponse.status} ${loginResponse.statusText}`
            );
          }

          if (!loginData.success) {
            throw new Error(`Login failed: ${loginData.message}`);
          }

          // Step 2: Process response
          if (loginData.data?.token) {
            // Case 1: Direct token response
            resultsDiv.textContent += `\n‚úÖ Case 1: Direct token received\n`;
            await handleDirectToken(loginData.data.token, resultsDiv);
          } else if (
            loginData.data?.code ||
            loginData.data?.authorizationCode
          ) {
            // Case 2: Authorization code response
            const authCode =
              loginData.data.code || loginData.data.authorizationCode;
            resultsDiv.textContent += `\n‚úÖ Case 2: Authorization code received\n`;
            resultsDiv.textContent += `Code: ${authCode.substring(0, 20)}...\n`;
            await handleAuthorizationCode(authCode, resultsDiv);
          } else {
            throw new Error(
              "Unexpected response format: no token or code found"
            );
          }
        } catch (error) {
          log(`Microsoft login test failed: ${error.message}`, "error");
          resultsDiv.textContent += `\n‚ùå Test Failed: ${error.message}\n`;
          resultsDiv.textContent += `\nTroubleshooting:\n`;
          resultsDiv.textContent += `1. Check if backend server is running\n`;
          resultsDiv.textContent += `2. Verify API endpoints are correctly implemented\n`;
          resultsDiv.textContent += `3. Check CORS settings\n`;
          resultsDiv.textContent += `4. Review backend logs for errors\n`;
          resultsDiv.className = "test-result error";
        }
      }

      async function handleDirectToken(token, resultsDiv) {
        // Save token to cookies
        document.cookie = `token=${token}; path=/; max-age=${7 * 24 * 60 * 60}`;
        document.cookie = `role=admin; path=/; max-age=${7 * 24 * 60 * 60}`;

        resultsDiv.textContent += `\nüíæ Token saved to cookies\n`;

        // Get admin profile
        await fetchAdminProfile(resultsDiv);

        resultsDiv.textContent += `\nüéâ Microsoft Login Flow Completed Successfully!\n`;
        resultsDiv.textContent += `Next: Navigate to /admin/dashboard\n`;
        resultsDiv.className = "test-result success";

        checkCurrentStatus();
      }

      async function handleAuthorizationCode(authCode, resultsDiv) {
        const apiBase = getApiBase();

        // Step 3: Exchange code for token
        resultsDiv.textContent += `\nüì° Step 3: Exchanging code for token...\n`;

        const callbackResponse = await fetch(`${apiBase}/admin/auth/callback`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            code: authCode,
          }),
        });

        const callbackData = await callbackResponse.json();
        resultsDiv.textContent += `\nüì• Callback Response (${callbackResponse.status}):\n`;
        resultsDiv.textContent += JSON.stringify(callbackData, null, 2) + "\n";

        if (!callbackResponse.ok) {
          throw new Error(
            `Callback API failed: ${callbackResponse.status} ${callbackResponse.statusText}`
          );
        }

        if (!callbackData.success || !callbackData.data?.token) {
          throw new Error(`Token exchange failed: ${callbackData.message}`);
        }

        // Save token
        const token = callbackData.data.token;
        document.cookie = `token=${token}; path=/; max-age=${7 * 24 * 60 * 60}`;
        document.cookie = `role=admin; path=/; max-age=${7 * 24 * 60 * 60}`;

        resultsDiv.textContent += `\nüíæ Token saved to cookies\n`;

        // Check if profile is included in callback response
        if (callbackData.data.adminProfile) {
          resultsDiv.textContent += `\n‚úÖ Admin profile included in callback response\n`;
          resultsDiv.textContent +=
            JSON.stringify(callbackData.data.adminProfile, null, 2) + "\n";
        } else {
          // Fetch profile separately
          await fetchAdminProfile(resultsDiv);
        }

        resultsDiv.textContent += `\nüéâ Microsoft Login Flow Completed Successfully!\n`;
        resultsDiv.textContent += `Next: Navigate to /admin/dashboard\n`;
        resultsDiv.className = "test-result success";

        checkCurrentStatus();
      }

      async function fetchAdminProfile(resultsDiv) {
        const apiBase = getApiBase();
        const token = getCookie("token");

        resultsDiv.textContent += `\nüì° Step 4: Fetching admin profile...\n`;

        const profileResponse = await fetch(`${apiBase}/admin/get-profile`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        });

        const profileData = await profileResponse.json();
        resultsDiv.textContent += `\nüì• Profile Response (${profileResponse.status}):\n`;
        resultsDiv.textContent += JSON.stringify(profileData, null, 2) + "\n";

        if (!profileResponse.ok) {
          resultsDiv.textContent += `\n‚ö†Ô∏è Profile fetch failed but login was successful\n`;
          return;
        }

        if (profileData.success && profileData.data) {
          resultsDiv.textContent += `\n‚úÖ Admin profile loaded successfully\n`;
          localStorage.setItem(
            "adminProfile",
            JSON.stringify(profileData.data)
          );
        }
      }

      // Manual testing functions
      async function testLoginEndpoint() {
        const resultsDiv = document.getElementById("manual-results");
        resultsDiv.textContent = "üß™ Testing Login Endpoint...\n";
        resultsDiv.className = "test-result info";

        try {
          const apiBase = getApiBase();
          const provider = getProvider();

          const response = await fetch(`${apiBase}/admin/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              provider: provider,
            }),
          });

          const data = await response.json();
          resultsDiv.textContent += `\nStatus: ${response.status} ${response.statusText}\n`;
          resultsDiv.textContent += `Response:\n${JSON.stringify(
            data,
            null,
            2
          )}\n`;

          if (response.ok && data.success) {
            resultsDiv.className = "test-result success";
          } else {
            resultsDiv.className = "test-result error";
          }
        } catch (error) {
          resultsDiv.textContent += `\nError: ${error.message}\n`;
          resultsDiv.className = "test-result error";
        }
      }

      async function testCallbackEndpoint() {
        const resultsDiv = document.getElementById("manual-results");
        const authCode = document.getElementById("authCode").value.trim();

        if (!authCode) {
          resultsDiv.textContent =
            "‚ùå Please enter an authorization code first";
          resultsDiv.className = "test-result error";
          return;
        }

        resultsDiv.textContent = "üß™ Testing Callback Endpoint...\n";
        resultsDiv.className = "test-result info";

        try {
          const apiBase = getApiBase();

          const response = await fetch(`${apiBase}/admin/auth/callback`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              code: authCode,
            }),
          });

          const data = await response.json();
          resultsDiv.textContent += `\nStatus: ${response.status} ${response.statusText}\n`;
          resultsDiv.textContent += `Response:\n${JSON.stringify(
            data,
            null,
            2
          )}\n`;

          if (response.ok && data.success) {
            resultsDiv.className = "test-result success";
          } else {
            resultsDiv.className = "test-result error";
          }
        } catch (error) {
          resultsDiv.textContent += `\nError: ${error.message}\n`;
          resultsDiv.className = "test-result error";
        }
      }

      async function testProfileEndpoint() {
        const resultsDiv = document.getElementById("manual-results");
        const token = getCookie("token");

        if (!token) {
          resultsDiv.textContent =
            "‚ùå No authentication token found. Please login first.";
          resultsDiv.className = "test-result error";
          return;
        }

        resultsDiv.textContent = "üß™ Testing Profile Endpoint...\n";
        resultsDiv.className = "test-result info";

        try {
          const apiBase = getApiBase();

          const response = await fetch(`${apiBase}/admin/get-profile`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();
          resultsDiv.textContent += `\nStatus: ${response.status} ${response.statusText}\n`;
          resultsDiv.textContent += `Response:\n${JSON.stringify(
            data,
            null,
            2
          )}\n`;

          if (response.ok && data.success) {
            resultsDiv.className = "test-result success";
          } else {
            resultsDiv.className = "test-result error";
          }
        } catch (error) {
          resultsDiv.textContent += `\nError: ${error.message}\n`;
          resultsDiv.className = "test-result error";
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        log("Admin Microsoft Login Test initialized");
        checkCurrentStatus();
      });
    </script>
  </body>
</html>
